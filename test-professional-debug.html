<!DOCTYPE html>
<html>
<head>
    <title>Teste E-mail Profissional - Agendiia</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-functions-compat.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .button { background: #4f46e5; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; margin: 8px; }
        .button:hover { background: #3730a3; }
        .log { background: #f3f4f6; padding: 15px; border-radius: 6px; font-family: monospace; white-space: pre-wrap; margin: 10px 0; }
        .success { color: #059669; }
        .error { color: #dc2626; }
        .warning { color: #d97706; }
        input[type="text"] { width: 300px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîß Teste de E-mail do Profissional</h1>
    
    <div>
        <h3>1. Verificar perfil do profissional</h3>
        <input type="text" id="userId" placeholder="ID do usu√°rio (profissional)" value="">
        <button class="button" onclick="checkProfile()">Verificar Perfil</button>
        <div id="profileResult" class="log" style="display:none;"></div>
    </div>

    <div>
        <h3>2. Criar agendamento de teste</h3>
        <input type="text" id="testUserId" placeholder="ID do usu√°rio (profissional)" value="">
        <button class="button" onclick="createTestAppointment()">Criar Agendamento</button>
        <div id="appointmentResult" class="log" style="display:none;"></div>
    </div>

    <div>
        <h3>3. Teste direto de e-mail</h3>
        <input type="text" id="testEmail" placeholder="E-mail do profissional" value="">
        <button class="button" onclick="sendTestEmail()">Enviar E-mail Teste</button>
        <div id="emailResult" class="log" style="display:none;"></div>
    </div>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            projectId: "timevee-53a3c",
            apiKey: "AIzaSyDEWTAQwzKw8RPNKaTyB2WObq4m1YBvnFc", // Client API key para conectar
            authDomain: "timevee-53a3c.firebaseapp.com"
        };
        firebase.initializeApp(firebaseConfig);
        
        const db = firebase.firestore();
        const functions = firebase.functions();
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<span class="${className}">[${new Date().toLocaleTimeString()}] ${message}</span>\\n`;
        }
        
        async function checkProfile() {
            const userId = document.getElementById('userId').value.trim();
            if (!userId) {
                alert('Digite o ID do usu√°rio');
                return;
            }
            
            document.getElementById('profileResult').innerHTML = '';
            log('profileResult', `Verificando perfil para usu√°rio: ${userId}`);
            
            try {
                // Check profile/main
                const profileDoc = await db.doc(`users/${userId}/profile/main`).get();
                if (profileDoc.exists) {
                    const data = profileDoc.data();
                    log('profileResult', `‚úÖ Profile encontrado:`, 'success');
                    log('profileResult', `   Nome: ${data.name || 'N/A'}`);
                    log('profileResult', `   E-mail: ${data.email || 'N/A'}`, data.email ? 'success' : 'warning');
                    log('profileResult', `   Telefone: ${data.phone || 'N/A'}`);
                } else {
                    log('profileResult', `‚ùå Profile n√£o encontrado em users/${userId}/profile/main`, 'error');
                }
                
                // Check top-level user doc
                const userDoc = await db.doc(`users/${userId}`).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    log('profileResult', `‚úÖ Documento users/${userId} encontrado:`, 'success');
                    log('profileResult', `   Nome: ${userData.name || 'N/A'}`);
                    log('profileResult', `   E-mail: ${userData.email || 'N/A'}`, userData.email ? 'success' : 'warning');
                } else {
                    log('profileResult', `‚ùå Documento users/${userId} n√£o encontrado`, 'error');
                }
                
            } catch (error) {
                log('profileResult', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function createTestAppointment() {
            const userId = document.getElementById('testUserId').value.trim();
            if (!userId) {
                alert('Digite o ID do usu√°rio');
                return;
            }
            
            document.getElementById('appointmentResult').innerHTML = '';
            log('appointmentResult', `Criando agendamento de teste para: ${userId}`);
            
            try {
                // Create appointment to trigger onAppointmentCreated
                const appointmentData = {
                    clientName: 'Cliente de Teste',
                    clientEmail: 'cliente@teste.com',
                    service: 'Consulta de Teste',
                    dateTime: firebase.firestore.Timestamp.now(),
                    duration: 60,
                    status: 'Agendado',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                const docRef = await db.collection(`users/${userId}/appointments`).add(appointmentData);
                log('appointmentResult', `‚úÖ Agendamento criado: ${docRef.id}`, 'success');
                log('appointmentResult', `üìß Isso deve disparar onAppointmentCreated e enviar e-mails`, 'success');
                log('appointmentResult', `üîç Verifique os logs do Firebase Console em alguns segundos`);
                
                // Wait a moment and check if appointment was created
                setTimeout(async () => {
                    try {
                        const check = await docRef.get();
                        if (check.exists) {
                            const data = check.data();
                            log('appointmentResult', `‚úÖ Confirmado: agendamento salvo no Firestore`, 'success');
                            if (data.confirmationEmailStatus) {
                                log('appointmentResult', `üìß Status do e-mail: ${data.confirmationEmailStatus}`, 'success');
                            }
                        }
                    } catch (e) {
                        log('appointmentResult', `‚ö†Ô∏è Erro ao verificar agendamento: ${e.message}`, 'warning');
                    }
                }, 3000);
                
            } catch (error) {
                log('appointmentResult', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function sendTestEmail() {
            const email = document.getElementById('testEmail').value.trim();
            if (!email) {
                alert('Digite o e-mail do profissional');
                return;
            }
            
            document.getElementById('emailResult').innerHTML = '';
            log('emailResult', `Enviando e-mail de teste para: ${email}`);
            
            try {
                const sendEmail = functions.httpsCallable('sendBrevoEmail');
                const result = await sendEmail({
                    toEmail: email,
                    toName: 'Profissional Teste',
                    subject: 'Teste de E-mail - Agendiia',
                    html: '<div><h2>‚úÖ Teste de E-mail</h2><p>Se voc√™ recebeu este e-mail, o sistema est√° funcionando corretamente!</p><p>Agendamento teste criado √†s ' + new Date().toLocaleString() + '</p></div>'
                });
                
                log('emailResult', `‚úÖ E-mail enviado com sucesso!`, 'success');
                log('emailResult', `üìß Message ID: ${result.data.messageId || 'N/A'}`);
                log('emailResult', `üéØ Verifique a caixa de entrada de ${email}`);
                
            } catch (error) {
                log('emailResult', `‚ùå Erro: ${error.message}`, 'error');
                console.error('Erro completo:', error);
            }
        }
    </script>
</body>
</html>
