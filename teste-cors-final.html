<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste CORS - Cloud Functions</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .test-result { margin: 10px 0; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .log-container { background: #1e1e1e; color: #fff; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste CORS - Cloud Functions</h1>
        <p>Esta p√°gina testa se o CORS est√° funcionando corretamente para as Cloud Functions.</p>
        
        <div id="firebase-status" class="status warning">
            üì° Inicializando Firebase...
        </div>
        
        <div class="test-section">
            <h2>üéØ Testes R√°pidos</h2>
            <button class="btn-primary" onclick="testarToggleUserStatus()">Testar Toggle Status</button>
            <button class="btn-warning" onclick="testarUpdateUser()">Testar Update User</button>
            <button class="btn-danger" onclick="testarDeleteUser()">Testar Delete User</button>
            <button class="btn-success" onclick="testarTodasFuncoes()">Testar Todas</button>
            <button class="btn-secondary" onclick="limparLog()" style="background: #6c757d; color: white;">Limpar Log</button>
        </div>
        
        <div class="test-section">
            <h2>üìä Resultado dos Testes</h2>
            <div id="test-summary" class="status info">
                Nenhum teste executado ainda.
            </div>
        </div>
        
        <div class="test-section">
            <h2>üìù Log Detalhado</h2>
            <div id="log-container" class="log-container">
                Aguardando testes...
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions.js"></script>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
        import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-functions.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDle5HF4ylU2K1_wGUS4odwk-RDcWHNp1M",
            authDomain: "timevee-53a3c.firebaseapp.com",
            projectId: "timevee-53a3c",
            storageBucket: "timevee-53a3c.appspot.com",
            messagingSenderId: "628542376232",
            appId: "1:628542376232:web:b1512d940c837370b3e81d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app);

        // Disponibilizar globalmente
        window.auth = auth;
        window.functions = functions;

        let testResults = {
            total: 0,
            success: 0,
            corsError: 0,
            otherError: 0
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('log-container');
            const color = {
                'success': '#4caf50',
                'error': '#f44336', 
                'cors': '#ff9800',
                'info': '#2196f3'
            }[type] || '#fff';
            
            logContainer.innerHTML += `<div style="color: ${color};">[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateSummary() {
            const summary = document.getElementById('test-summary');
            const { total, success, corsError, otherError } = testResults;
            
            if (total === 0) {
                summary.innerHTML = 'Nenhum teste executado ainda.';
                summary.className = 'status info';
            } else if (corsError > 0) {
                summary.innerHTML = `‚ùå CORS PROBLEM√ÅTICO: ${corsError}/${total} fun√ß√µes com erro de CORS`;
                summary.className = 'status error';
            } else if (otherError === total) {
                summary.innerHTML = `‚úÖ CORS OK: Todas as ${total} fun√ß√µes rejeitaram por permiss√£o (n√£o CORS)`;
                summary.className = 'status success';
            } else {
                summary.innerHTML = `‚ö†Ô∏è RESULTADOS MISTOS: ${success} sucessos, ${otherError} erros de permiss√£o, ${corsError} erros CORS`;
                summary.className = 'status warning';
            }
        }

        async function testFunction(name, data = {}) {
            testResults.total++;
            log(`üîÑ Testando ${name}...`);
            
            try {
                const callable = httpsCallable(functions, name);
                const result = await callable(data);
                
                testResults.success++;
                log(`‚úÖ ${name}: Sucesso - ${JSON.stringify(result.data)}`, 'success');
                return true;
                
            } catch (error) {
                const errorMsg = error.message || error.toString();
                
                if (errorMsg.includes('CORS') || errorMsg.includes('Access-Control') || 
                    errorMsg.includes('preflight') || errorMsg.includes('blocked')) {
                    testResults.corsError++;
                    log(`üö´ ${name}: ERRO DE CORS - ${errorMsg}`, 'cors');
                    return false;
                } else {
                    testResults.otherError++;
                    log(`‚ö†Ô∏è ${name}: Erro esperado (permiss√£o/valida√ß√£o) - ${errorMsg}`, 'error');
                    return true; // Erro de permiss√£o √© esperado, significa que CORS est√° OK
                }
            } finally {
                updateSummary();
            }
        }

        // Fun√ß√µes dispon√≠veis globalmente
        window.testarToggleUserStatus = () => testFunction('toggleUserStatus', { userId: 'test-123' });
        window.testarUpdateUser = () => testFunction('updatePlatformUser', { userId: 'test-123', userData: {name: 'Test'} });
        window.testarDeleteUser = () => testFunction('deletePlatformUser', { userId: 'test-123' });
        
        window.testarTodasFuncoes = async () => {
            log('üöÄ Iniciando teste de todas as fun√ß√µes...', 'info');
            testResults = { total: 0, success: 0, corsError: 0, otherError: 0 };
            
            await window.testarToggleUserStatus();
            await window.testarUpdateUser();
            await window.testarDeleteUser();
            
            log('üèÅ Todos os testes conclu√≠dos!', 'info');
        };
        
        window.limparLog = () => {
            document.getElementById('log-container').innerHTML = 'Log limpo...';
            testResults = { total: 0, success: 0, corsError: 0, otherError: 0 };
            updateSummary();
        };

        // Verificar status do Firebase
        onAuthStateChanged(auth, (user) => {
            const statusDiv = document.getElementById('firebase-status');
            if (user) {
                statusDiv.innerHTML = `‚úÖ Firebase conectado - Usu√°rio: ${user.email}`;
                statusDiv.className = 'status success';
                log(`Firebase Auth: Usu√°rio conectado - ${user.email}`, 'success');
            } else {
                statusDiv.innerHTML = '‚ö†Ô∏è Firebase conectado - Usu√°rio n√£o autenticado (normal para testes)';
                statusDiv.className = 'status warning';
                log('Firebase Auth: Usu√°rio n√£o autenticado (normal para testes)', 'info');
            }
        });

        // Teste inicial autom√°tico
        setTimeout(() => {
            log('üéØ P√°gina carregada. Pronto para testes!', 'info');
            log('üí° DICA: Se as fun√ß√µes retornarem erro de "permiss√£o negada" em vez de CORS, ent√£o o CORS est√° funcionando!', 'info');
        }, 1000);
    </script>
</body>
</html>
